# Change Request: CR-2026-02-20-001

## ðŸ“‹ CHANGE REQUEST

### Request ID
`CR-2026-02-20-001`

### Request Type
- [x] New Feature

### Priority
- [x] High (important, this sprint)

---

## ðŸ“ DESCRIPTION

### Summary
Implement Tier 1: SSO Authentication & User Management for FantasyFolio v0.5.0

### Detailed Description
Add multi-provider authentication (Discord, Google, Apple, Email/Password), user management, user settings, dashboard personalization, notifications, and cross-asset collections as defined in `TIER1_DETAILED_SPEC.md`.

### Acceptance Criteria
**Phase 1 - Core Auth (Must Have for v0.5.0)**
- [ ] Email/password signup with validation
- [ ] Email/password login
- [ ] Discord SSO login
- [ ] User profile (display name, avatar)
- [ ] Session management (12-hour expiry)
- [ ] Logout functionality

**Phase 2 - Additional SSO (v0.5.1)**
- [ ] Google SSO
- [ ] Apple SSO
- [ ] Link multiple providers to one account

**Phase 3 - User Settings (v0.5.1)**
- [ ] Theme toggle (Dark/Light/Parchment)
- [ ] Timezone/locale settings
- [ ] Connected accounts management

**Phase 4 - Dashboard (v0.5.2)**
- [ ] Recently viewed assets
- [ ] Recently uploaded assets
- [ ] Pinned tags
- [ ] Dashboard customization

**Phase 5 - Collections (v0.5.2)**
- [ ] Create private collection
- [ ] Add items to collection (3D + PDF)
- [ ] View collection
- [ ] Share collection with users

**Phase 6 - Notifications (v0.5.3)**
- [ ] In-app notifications
- [ ] Email notifications
- [ ] Discord webhook

### Proposed Release Plan
| Version | Scope | Target |
|---------|-------|--------|
| v0.5.0 | Core Auth (Email + Discord) | Week 1-2 |
| v0.5.1 | Google/Apple SSO + Settings | Week 2-3 |
| v0.5.2 | Dashboard + Collections | Week 3-4 |
| v0.5.3 | Notifications | Week 4-5 |

---

## ðŸ—ƒï¸ DATABASE CHANGES

### Schema Changes Required?
- [x] Yes

### New Tables

```sql
-- Users table
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    email_verified INTEGER DEFAULT 0,
    password_hash TEXT,
    display_name TEXT NOT NULL UNIQUE,
    avatar_url TEXT,
    role TEXT DEFAULT 'user',
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
    last_login_at TEXT,
    is_active INTEGER DEFAULT 1,
    deleted_at TEXT
);

-- SSO provider links
CREATE TABLE user_oauth (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider TEXT NOT NULL,
    provider_user_id TEXT NOT NULL,
    access_token_encrypted TEXT,
    refresh_token_encrypted TEXT,
    token_expires_at TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(provider, provider_user_id)
);

-- User preferences
CREATE TABLE user_settings (
    user_id TEXT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    timezone TEXT DEFAULT 'UTC',
    locale TEXT DEFAULT 'en-US',
    theme TEXT DEFAULT 'dark',
    dashboard_config TEXT,
    notification_prefs TEXT,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- Sessions
CREATE TABLE user_sessions (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    refresh_token_hash TEXT NOT NULL,
    device_info TEXT,
    ip_address TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    expires_at TEXT NOT NULL,
    revoked_at TEXT
);

-- Email verification/reset tokens
CREATE TABLE email_tokens (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash TEXT NOT NULL,
    token_type TEXT NOT NULL,
    expires_at TEXT NOT NULL,
    used_at TEXT
);

-- Collections
CREATE TABLE collections (
    id TEXT PRIMARY KEY,
    owner_id TEXT NOT NULL REFERENCES users(id),
    name TEXT NOT NULL,
    description TEXT,
    cover_image_url TEXT,
    visibility TEXT DEFAULT 'private',
    collection_type TEXT DEFAULT 'manual',
    smart_filter TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- Collection items (cross-asset)
CREATE TABLE collection_items (
    id TEXT PRIMARY KEY,
    collection_id TEXT NOT NULL REFERENCES collections(id) ON DELETE CASCADE,
    model_id INTEGER REFERENCES models(id) ON DELETE CASCADE,
    asset_id INTEGER REFERENCES assets(id) ON DELETE CASCADE,
    added_at TEXT DEFAULT CURRENT_TIMESTAMP,
    added_by TEXT REFERENCES users(id),
    sort_order INTEGER,
    notes TEXT,
    CHECK ((model_id IS NOT NULL AND asset_id IS NULL) OR (model_id IS NULL AND asset_id IS NOT NULL))
);

-- Collection sharing
CREATE TABLE collection_shares (
    id TEXT PRIMARY KEY,
    collection_id TEXT NOT NULL REFERENCES collections(id) ON DELETE CASCADE,
    shared_with_user_id TEXT REFERENCES users(id),
    permission TEXT DEFAULT 'view',
    guest_token_hash TEXT,
    expires_at TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    created_by TEXT REFERENCES users(id)
);

-- Notifications
CREATE TABLE notifications (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    title TEXT NOT NULL,
    body TEXT,
    data TEXT,
    read_at TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_user_oauth_user ON user_oauth(user_id);
CREATE INDEX idx_user_oauth_provider ON user_oauth(provider, provider_user_id);
CREATE INDEX idx_sessions_user ON user_sessions(user_id);
CREATE INDEX idx_sessions_token ON user_sessions(refresh_token_hash);
CREATE INDEX idx_collections_owner ON collections(owner_id);
CREATE INDEX idx_collection_items_collection ON collection_items(collection_id);
CREATE INDEX idx_collection_items_model ON collection_items(model_id);
CREATE INDEX idx_collection_items_asset ON collection_items(asset_id);
CREATE INDEX idx_notifications_user ON notifications(user_id);
```

### Migration Required?
- [x] Yes - but v0.5.0 is greenfield for auth (no existing users to migrate)

### Files to Update
- [x] `data/schema.sql`
- [ ] `fantasyfolio/migrations/004_add_auth_tables.py` (for existing DBs)
- [x] `fantasyfolio/core/database.py`

---

## ðŸ”Œ API CHANGES

### New Endpoints

**Authentication**
| Method | Path | Description |
|--------|------|-------------|
| POST | /api/auth/register | Email/password signup |
| POST | /api/auth/login | Email/password login |
| POST | /api/auth/logout | End session |
| POST | /api/auth/refresh | Refresh access token |
| POST | /api/auth/verify-email | Verify email token |
| POST | /api/auth/forgot-password | Request password reset |
| POST | /api/auth/reset-password | Complete password reset |
| GET | /api/auth/oauth/discord | Start Discord OAuth |
| GET | /api/auth/oauth/discord/callback | Discord OAuth callback |
| GET | /api/auth/me | Get current user |
| PATCH | /api/auth/me | Update profile |

**User Settings**
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/user/settings | Get settings |
| PATCH | /api/user/settings | Update settings |
| GET | /api/user/sessions | List active sessions |
| DELETE | /api/user/sessions/:id | Revoke session |

**Collections**
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/collections | List user's collections |
| POST | /api/collections | Create collection |
| GET | /api/collections/:id | Get collection |
| PATCH | /api/collections/:id | Update collection |
| DELETE | /api/collections/:id | Delete collection |
| POST | /api/collections/:id/items | Add items |
| DELETE | /api/collections/:id/items/:itemId | Remove item |
| POST | /api/collections/:id/share | Share collection |

**Notifications**
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/notifications | List notifications |
| PATCH | /api/notifications/:id/read | Mark as read |
| POST | /api/notifications/read-all | Mark all as read |

---

## ðŸ“ FILES TO CREATE/MODIFY

### New Files
- `fantasyfolio/api/auth.py` - Authentication endpoints
- `fantasyfolio/api/users.py` - User management endpoints
- `fantasyfolio/api/collections.py` - Collections endpoints
- `fantasyfolio/api/notifications.py` - Notifications endpoints
- `fantasyfolio/services/auth.py` - Auth business logic
- `fantasyfolio/services/users.py` - User service
- `fantasyfolio/services/collections.py` - Collections service
- `fantasyfolio/services/notifications.py` - Notifications service
- `fantasyfolio/core/security.py` - Password hashing, JWT, encryption
- `fantasyfolio/core/oauth.py` - OAuth client wrapper
- `templates/login.html` - Login page
- `templates/register.html` - Registration page
- `templates/settings.html` - User settings page

### Modified Files
- `fantasyfolio/app.py` - Register new blueprints
- `fantasyfolio/__init__.py` - Version bump
- `templates/index.html` - Add auth UI, collections sidebar
- `requirements.txt` - Add auth dependencies
- `data/schema.sql` - Add new tables
- `docker/entrypoint.sh` - Handle auth config

### Configuration
- `Dockerfile` - No changes expected
- `.env.example` - Add auth config vars

### Dependencies to Add
```
authlib>=1.3.0
PyJWT>=2.8.0
argon2-cffi>=23.1.0
python-jose>=3.3.0
```

---

## ðŸ§ª TESTING REQUIREMENTS

### Test Environment
- [x] Docker on Mac (port 8895)
- [x] Docker on Windows (port 8888)

### Test Cases - Phase 1 (v0.5.0)
| # | Test Case | Expected Result |
|---|-----------|-----------------|
| 1 | Register with valid email/password | Account created, verification email sent |
| 2 | Register with existing email | Error: "Email already registered" |
| 3 | Register with weak password | Error: Password requirements not met |
| 4 | Login with correct credentials | JWT returned, session created |
| 5 | Login with wrong password | Error: "Invalid credentials" |
| 6 | Login after 5 failures | Rate limited |
| 7 | Discord OAuth flow | Redirects to Discord, returns with user logged in |
| 8 | Logout | Session invalidated |
| 9 | Access protected route without token | 401 Unauthorized |
| 10 | Access protected route with expired token | 401, auto-refresh attempted |

---

## âœ… PRE-IMPLEMENTATION CHECKLIST

- [x] Requirements are clear (TIER1_DETAILED_SPEC.md)
- [x] Database schema documented above
- [x] API contracts defined above
- [ ] **CONFIRM**: Start with v0.5.0 scope (Email + Discord auth only)?
- [ ] **CONFIRM**: Auth is optional initially (existing browse works without login)?

---

## ðŸ’¬ QUESTIONS BEFORE STARTING

1. **Auth Required or Optional?**
   - Option A: Auth required for everything (breaking change)
   - Option B: Auth optional - browse works without login, auth needed for collections/sharing
   - **Recommendation:** Option B for smoother transition

2. **Discord App Setup**
   - Do you have a Discord Developer Application created?
   - Need: Client ID, Client Secret, Redirect URI

3. **Email Service**
   - What email provider for verification emails?
   - Options: SMTP, SendGrid, AWS SES
   - Or skip email verification for v0.5.0?

4. **Start with v0.5.0 scope only?**
   - Just Email + Discord auth
   - Basic user profile
   - No collections yet (defer to v0.5.2)

---

**Awaiting confirmation before coding begins.**
