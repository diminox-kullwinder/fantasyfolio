<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPG Library</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: rgba(255,255,255,0.05);
      --text-primary: #e4e4e4;
      --text-secondary: #888;
      --accent: #4dabf7;
      --accent-hover: #74c0fc;
      --border: rgba(255,255,255,0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      min-height: 100vh;
      color: var(--text-primary);
    }
    
    /* Layout */
    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .app-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Header */
    header {
      background: rgba(0,0,0,0.3);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    
    .content-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 8px;
    }
    
    .toggle-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .toggle-btn:hover {
      color: var(--text-primary);
    }
    
    .toggle-btn.active {
      background: var(--accent);
      color: white;
    }
    
    .settings-btn {
      background: transparent;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      padding: 8px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .settings-btn:hover {
      opacity: 1;
    }
    
    .search-box {
      flex: 1;
      max-width: 600px;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1rem;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .adv-search-toggle {
      padding: 10px 14px;
      border-radius: 0 8px 8px 0;
      border: 1px solid var(--border);
      border-left: none;
      background: var(--bg-card);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .adv-search-toggle:hover,
    .adv-search-toggle.active {
      background: var(--accent);
      color: white;
    }
    
    .search-box input {
      border-radius: 8px 0 0 8px;
    }
    
    .search-box {
      display: flex;
    }
    
    .stats {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    /* Advanced Search Panel */
    .advanced-search-panel {
      display: none;
      background: rgba(0,0,0,0.3);
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    
    .advanced-search-panel.open {
      display: block;
    }
    
    .adv-search-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .adv-search-close:hover {
      color: #e74c3c;
      background: rgba(231,76,60,0.1);
    }
    
    .adv-search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .adv-search-row:last-child {
      margin-bottom: 0;
    }
    
    .adv-search-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .adv-search-group label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .adv-search-group select,
    .adv-search-group input[type="number"] {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    
    .adv-search-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    
    .adv-search-terms {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }
    
    .adv-term-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
    }
    
    .term-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      min-width: 50px;
    }
    
    .term-operator {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .term-include {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    
    .term-input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .term-remove {
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
    }
    
    .term-remove:hover {
      color: #e74c3c;
    }
    
    .btn-add-term {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .btn-add-term:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .btn-apply {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .btn-clear {
      padding: 8px 16px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .btn-clear:hover {
      border-color: #e74c3c;
      color: #e74c3c;
    }
    
    /* Sidebar */
    .sidebar {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      overflow: auto;
      width: 300px;
      min-width: 150px;
      flex-shrink: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) rgba(255,255,255,0.1);
    }
    
    .sidebar::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 5px;
    }
    
    .resize-handle {
      width: 8px;
      background: rgba(255,255,255,0.1);
      cursor: col-resize;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .resize-handle:hover,
    .resize-handle.dragging {
      background: var(--accent);
    }
    
    .folder-tree {
      margin-bottom: 24px;
    }
    
    /* Main Content - defined below */
    
    .sidebar h3 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .folder-list, .publisher-list {
      list-style: none;
      margin-bottom: 24px;
    }
    
    .folder-list li, .publisher-list li {
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    
    .folder-list li:hover, .publisher-list li:hover {
      background: var(--bg-card);
    }
    
    .folder-list li.active, .publisher-list li.active {
      background: var(--accent);
      color: white;
    }
    
    /* Tree structure */
    .folder-tree {
      list-style: none;
      margin-bottom: 24px;
      font-size: 0.85rem;
    }
    
    .tree-item {
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    .tree-item:hover {
      background: var(--bg-card);
    }
    
    .tree-item.active {
      background: var(--accent);
      color: white;
    }
    
    .tree-item .toggle {
      width: 16px;
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .tree-item.active .toggle {
      color: rgba(255,255,255,0.7);
    }
    
    .tree-item .folder-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .tree-children {
      display: none;
    }
    
    .tree-children.expanded {
      display: block;
      min-width: max-content;
    }
    
    .count-badge {
      background: var(--bg-card);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .active .count-badge {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    /* Main Content */
    .main {
      padding: 24px;
      overflow: auto;
      flex: 1;
    }
    
    .view-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .view-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .view-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .sort-controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    
    .sort-controls select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      color: #222;
      font-size: 0.85rem;
      cursor: pointer;
      color-scheme: light;
    }
    
    .sort-controls select option {
      background: #fff;
      color: #222;
    }
    
    .clear-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .clear-btn:hover {
      background: #e74c3c;
      border-color: #e74c3c;
      color: white;
    }
    
    /* Grid View */
    .asset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .asset-card {
      background: var(--bg-card);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .asset-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    .asset-thumb {
      width: 100%;
      aspect-ratio: 3/4;
      object-fit: cover;
      background: var(--bg-secondary);
    }
    
    .asset-info {
      padding: 12px;
    }
    
    .asset-title {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    
    .asset-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    /* List View */
    .asset-list {
      display: none;
    }
    
    .asset-list.active {
      display: block;
    }
    
    .asset-grid.hidden {
      display: none;
    }
    
    .asset-row {
      display: grid;
      grid-template-columns: 60px 1fr 150px 100px 80px;
      gap: 16px;
      padding: 12px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 8px;
      align-items: center;
      cursor: pointer;
    }
    
    .asset-row:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .asset-row img {
      width: 60px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .asset-row .title {
      font-weight: 500;
    }
    
    .asset-row .publisher {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .asset-row .pages, .asset-row .size {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-align: right;
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .modal-body {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 24px;
      padding: 24px;
    }
    
    .modal-thumb {
      width: 100%;
      border-radius: 8px;
    }
    
    .modal-details h2 {
      margin-bottom: 16px;
      font-size: 1.4rem;
    }
    
    .detail-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .detail-label {
      width: 120px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .detail-value {
      flex: 1;
      font-size: 0.9rem;
    }
    
    .breadcrumbs {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
    }
    
    .breadcrumb-link {
      color: var(--accent);
      text-decoration: none;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    
    .breadcrumb-link:hover {
      background: var(--accent);
      color: white;
    }
    
    .breadcrumb-sep {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    /* Page Extraction */
    .page-extract-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .page-extract-section h4 {
      font-size: 0.95rem;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .page-extract-row {
      display: flex;
      gap: 8px;
    }
    
    .page-input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .page-extract-hint {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    
    /* Search Matches in Detail Modal */
    .search-matches-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .search-matches-section h4 {
      font-size: 0.95rem;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .search-matches-list {
      max-height: 250px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .search-matches-list .page-match {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: rgba(77, 171, 247, 0.1);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      align-items: flex-start;
      border: 1px solid transparent;
    }
    
    .search-matches-list .page-match:hover {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .search-matches-list .page-num {
      background: var(--accent);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .search-matches-list .page-match:hover .page-num {
      background: white;
      color: var(--accent);
    }
    
    .search-matches-list .snippet {
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .search-matches-list .snippet mark {
      background: rgba(77, 171, 247, 0.3);
      color: var(--text-primary);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    /* Bookmarks/TOC */
    .bookmarks-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .bookmarks-section h4 {
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bookmarks-section h4:hover {
      color: var(--accent);
    }
    
    .bookmarks-list {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 8px;
    }
    
    .bookmark-item {
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .bookmark-item:hover {
      background: var(--bg-card);
    }
    
    .bookmark-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .bookmark-page {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-left: 8px;
    }
    
    .bookmark-level-1 { padding-left: 0; }
    .bookmark-level-2 { padding-left: 16px; }
    .bookmark-level-3 { padding-left: 32px; }
    .bookmark-level-4 { padding-left: 48px; }
    
    .bookmarks-empty {
      color: var(--text-secondary);
      font-size: 0.85rem;
      padding: 12px;
      text-align: center;
    }
    
    /* Content Search Results */
    .content-results {
      margin-bottom: 24px;
      background: var(--bg-card);
      border-radius: 10px;
      padding: 16px;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    .content-grid.hidden {
      display: none;
    }
    
    .content-list.hidden {
      display: none;
    }
    
    .content-results h3 {
      font-size: 1rem;
      margin-bottom: 16px;
      color: var(--accent);
    }
    
    .content-results-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .content-result-card {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 12px;
    }
    
    .content-result-header {
      display: flex;
      gap: 12px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    
    .content-result-header img {
      width: 50px;
      height: 65px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .content-result-header .title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .content-result-header .path {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .page-matches {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-left: 62px;
    }
    
    .page-match {
      display: flex;
      gap: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      align-items: flex-start;
    }
    
    .page-match:hover {
      background: var(--accent);
    }
    
    .page-num {
      background: var(--accent);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .page-match:hover .page-num {
      background: white;
      color: var(--accent);
    }
    
    .snippet {
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .snippet mark {
      background: rgba(77, 171, 247, 0.3);
      color: var(--text-primary);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .more-pages {
      font-size: 0.8rem;
      color: var(--text-secondary);
      padding: 4px 8px;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    /* 3D Model Icons */
    .model-icon {
      font-size: 4rem;
      text-align: center;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }
    
    .model-icon-small {
      font-size: 1.5rem;
      width: 40px;
      text-align: center;
    }
    
    .model-preview-icon {
      font-size: 6rem;
      text-align: center;
      padding: 30px;
      background: var(--bg-card);
      border-radius: 8px;
    }
    
    /* 3D Model Preview in Modal */
    .model-preview-area {
      position: relative;
    }
    
    .model-thumb-img {
      width: 100%;
      max-width: 200px;
      height: auto;
      border-radius: 8px;
      background: var(--bg-card);
    }
    
    .model-thumb-fallback {
      width: 200px;
      height: 200px;
      font-size: 4rem;
      background: var(--bg-card);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* 3D Viewer */
    .viewer-3d {
      display: none;
      width: 200px;
      height: 200px;
      background: #1a1a2e;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .viewer-controls {
      display: none;
      position: absolute;
      bottom: 8px;
      left: 8px;
      gap: 4px;
      z-index: 10;
    }
    
    .viewer-controls button {
      background: rgba(0,0,0,0.8);
      color: var(--text-primary);
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    .viewer-controls button:hover {
      background: var(--accent);
    }
    
    /* 3D Grid Thumbnail */
    .model-grid-thumb {
      object-fit: contain;
      background: var(--bg-card);
    }
    
    /* Collection list */
    .collection-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .collection-list li {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    
    .collection-list li:hover {
      background: var(--bg-card);
    }
    
    .collection-list li.active {
      background: var(--accent);
      color: white;
    }
    
    /* Upload Modal */
    .upload-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    
    .upload-overlay.active {
      display: flex;
    }
    
    .upload-modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .upload-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .upload-header h2 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .upload-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .upload-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .upload-section {
      margin-bottom: 20px;
    }
    
    .upload-section h3 {
      font-size: 0.95rem;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .upload-path-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .upload-path-display .path {
      flex: 1;
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--accent);
      word-break: break-all;
    }
    
    .upload-folder-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .upload-folder-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .upload-folder-item:last-child {
      border-bottom: none;
    }
    
    .upload-folder-item:hover {
      background: var(--bg-card);
    }
    
    .upload-folder-item.parent {
      color: var(--text-secondary);
    }
    
    .upload-new-folder {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .upload-new-folder input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .upload-new-folder button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .upload-dropzone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-dropzone:hover,
    .upload-dropzone.dragover {
      border-color: var(--accent);
      background: rgba(77, 171, 247, 0.1);
    }
    
    .upload-dropzone-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    .upload-dropzone-text {
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .upload-dropzone-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .upload-file-list {
      margin-top: 16px;
    }
    
    .upload-file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .upload-file-item .name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .upload-file-item .size {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .upload-file-item .remove {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0 4px;
    }
    
    .upload-file-item .remove:hover {
      color: #e74c3c;
    }
    
    .upload-progress {
      margin-top: 12px;
      display: none;
    }
    
    .upload-progress.active {
      display: block;
    }
    
    .upload-progress-bar {
      height: 8px;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .upload-progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.3s;
    }
    
    .upload-progress-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 6px;
      text-align: center;
    }
    
    .upload-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    
    .upload-footer .file-count {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .upload-footer .buttons {
      display: flex;
      gap: 12px;
    }
    
    /* Settings Modal */
    .settings-overlay, .browser-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    
    .settings-overlay.active, .browser-overlay.active {
      display: flex;
    }
    
    .settings-modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .settings-header h2 {
      margin: 0;
      font-size: 1.3rem;
    }
    
    .settings-close, .browser-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .settings-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .settings-section {
      margin-bottom: 24px;
    }
    
    .settings-section h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--accent);
    }
    
    .settings-field {
      margin-bottom: 16px;
    }
    
    .settings-field label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .settings-field input, .settings-field textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .settings-field textarea {
      resize: vertical;
      font-family: monospace;
    }
    
    .path-input-row {
      display: flex;
      gap: 8px;
    }
    
    .path-input-row input {
      flex: 1;
    }
    
    .path-input-row button {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
    }
    
    .path-input-row button:hover {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .index-btn {
      padding: 10px 14px;
      background: #2d5a3d;
      border: 1px solid #3d7a4d;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    
    .index-btn:hover {
      background: #3d7a4d;
    }
    
    .index-btn.smb-index {
      margin-top: 8px;
      width: 100%;
    }
    
    .index-status {
      font-size: 0.8rem;
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 4px;
      display: none;
    }
    
    .index-status.active {
      display: block;
      background: rgba(77, 171, 247, 0.2);
      color: var(--accent);
    }
    
    .index-status.success {
      display: block;
      background: rgba(61, 122, 77, 0.2);
      color: #6fbf8a;
    }
    
    .index-status.error {
      display: block;
      background: rgba(200, 80, 80, 0.2);
      color: #e08080;
    }
    
    .index-status.info {
      display: block !important;
      background: rgba(77, 171, 247, 0.2);
      color: #4dabf7;
    }
    
    .settings-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border);
    }
    
    /* Directory Browser */
    .browser-modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
    }
    
    .browser-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .browser-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    
    .browser-path {
      padding: 10px 20px;
      background: var(--bg-card);
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--accent);
      border-bottom: 1px solid var(--border);
    }
    
    .browser-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .browser-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
    }
    
    .browser-item:hover {
      background: var(--bg-card);
    }
    
    .browser-item.parent {
      color: var(--text-secondary);
    }
    
    .browser-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 12px 20px;
      border-top: 1px solid var(--border);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
      .modal-body {
        grid-template-columns: 1fr;
      }
    }
    
    /* Page Preview Modal */
    .page-preview-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .page-preview-overlay.active {
      display: flex;
    }
    
    .page-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 900px;
      padding: 12px 20px;
      color: white;
    }
    
    .page-preview-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .page-preview-nav button, .page-preview-zoom button {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.2s;
    }
    
    .page-preview-nav button:hover:not(:disabled),
    .page-preview-zoom button:hover:not(:disabled) {
      background: var(--accent);
    }
    
    .page-preview-nav button:disabled,
    .page-preview-zoom button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .page-preview-info {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.8);
    }
    
    .page-preview-zoom {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 24px;
      padding-left: 24px;
      border-left: 1px solid rgba(255,255,255,0.2);
    }
    
    .page-preview-zoom button {
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
    }
    
    .zoom-level {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
      min-width: 50px;
      text-align: center;
    }
    
    .page-preview-title {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .page-preview-close {
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
    }
    
    .page-preview-close:hover {
      color: var(--accent);
    }
    
    .page-preview-image-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
      max-width: 100%;
    }
    
    .page-preview-image {
      max-height: calc(100vh - 200px);
      max-width: 100%;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    
    .page-preview-image.loading {
      opacity: 0.5;
    }
    
    .page-preview-footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 16px 20px;
      background: rgba(0,0,0,0.5);
      width: 100%;
    }
    
    .page-preview-footer label {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
    }
    
    .page-range-select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(30,30,50,0.95);
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .page-range-select option {
      background: #1e1e32;
      color: white;
      padding: 8px;
    }
    
    .page-range-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .page-preview-download {
      padding: 10px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .page-preview-download:hover {
      background: var(--accent-hover);
    }
  </style>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"></head>
<body>
  <div class="app">
    <header>
      <div class="logo" onclick="goHome()" style="cursor:pointer" title="Return to home view">üìö RPG Library</div>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search PDFs..." />
        <button class="adv-search-toggle" onclick="toggleAdvancedSearch()" title="Advanced Search">‚öô</button>
      </div>
      <div class="content-toggle">
        <button class="toggle-btn active" id="togglePdf" onclick="setContentType('pdf')">üìÑ PDFs</button>
        <button class="toggle-btn" id="toggle3d" onclick="setContentType('3d')">üé≤ 3D Models</button>
      </div>
      <div class="stats" id="stats">Loading...</div>
      <button class="settings-btn" onclick="openUpload()" title="Upload files" id="uploadBtn">‚¨ÜÔ∏è</button>
      <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </header>
    
    <div class="advanced-search-panel" id="advancedSearchPanel">
      <button class="adv-search-close" onclick="toggleAdvancedSearch()" title="Close">‚úï</button>
      <div class="adv-search-row">
        <div class="adv-search-group">
          <label>Search in:</label>
          <select id="advSearchScope">
            <option value="all">All folders</option>
            <option value="current" id="advScopeCurrent">Current folder</option>
          </select>
        </div>
      </div>
      
      <div class="adv-search-terms" id="advSearchTerms">
        <div class="adv-term-row" data-row="0">
          <span class="term-label">Find in</span>
          <select class="term-field">
            <option value="all">Title & Content</option>
            <option value="title">Title only</option>
            <option value="content">Content only</option>
          </select>
          <select class="term-include">
            <option value="include">contains</option>
            <option value="exclude">does NOT contain</option>
          </select>
          <input type="text" class="term-input" placeholder="Enter search term..." />
        </div>
      </div>
      
      <div class="adv-search-row" style="margin-top:12px">
        <button class="btn-add-term" onclick="addSearchTerm()">+ Add condition</button>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button class="btn-apply" onclick="runAdvancedSearch()">Search</button>
          <button class="btn-clear" onclick="clearAdvancedSearch()">Clear</button>
        </div>
      </div>
    </div>
    
    <div class="app-body">
    <aside class="sidebar" id="sidebar">
      <!-- PDF Navigation -->
      <div id="pdfNav">
        <h3>üìÅ Folders</h3>
        <div class="folder-tree" id="folderTree"></div>
        
        <h3>üè¢ Publishers</h3>
        <ul class="publisher-list" id="publisherList"></ul>
      </div>
      
      <!-- 3D Models Navigation -->
      <div id="modelsNav" style="display:none;">
        <h3>üìÇ Folders</h3>
        <div class="folder-tree" id="modelFolderTree"></div>
        
        <h3>üì¶ Collections</h3>
        <ul class="collection-list" id="collectionList"></ul>
      </div>
    </aside>
    <div class="resize-handle" id="resizeHandle"></div>
    
    <main class="main">
      <div class="view-controls">
        <button class="view-btn active" data-view="grid">Grid</button>
        <button class="view-btn" data-view="list">List</button>
        <div class="sort-controls">
          <select id="formatFilter" onchange="changeFormatFilter()" style="display:none;">
            <option value="">All Formats</option>
            <option value="stl">STL</option>
            <option value="obj">OBJ</option>
            <option value="3mf">3MF</option>
          </select>
          <select id="sortSelect" onchange="changeSort()">
            <option value="filename:asc">Name (A-Z)</option>
            <option value="filename:desc">Name (Z-A)</option>
            <option value="title:asc">Title (A-Z)</option>
            <option value="title:desc">Title (Z-A)</option>
            <option value="file_size:desc">Size (Large first)</option>
            <option value="file_size:asc">Size (Small first)</option>
            <option value="page_count:desc">Pages (Most first)</option>
            <option value="page_count:asc">Pages (Least first)</option>
            <option value="modified_at:desc">Modified (Newest)</option>
            <option value="modified_at:asc">Modified (Oldest)</option>
          </select>
          <button class="clear-btn" onclick="clearFilters()" title="Clear all filters">‚úï Clear</button>
        </div>
      </div>
      
      <div class="content-results" id="contentResults" style="display:none;"></div>
      <div class="asset-grid" id="assetGrid"></div>
      <div class="asset-list" id="assetList"></div>
    </main>
  </div>
  </div>
  
  <!-- Detail Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Asset Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Page Preview Modal -->
  <div class="page-preview-overlay" id="pagePreview">
    <div class="page-preview-header">
      <div class="page-preview-nav">
        <button onclick="previewPrevPage()" id="prevPageBtn" title="Previous page">‚óÄ</button>
        <span class="page-preview-info">
          Page <span id="previewPageNum">1</span> of <span id="previewTotalPages">1</span>
        </span>
        <button onclick="previewNextPage()" id="nextPageBtn" title="Next page">‚ñ∂</button>
        <div class="page-preview-zoom">
          <button onclick="zoomOut()" title="Zoom out">‚àí</button>
          <span class="zoom-level" id="zoomLevel">100%</span>
          <button onclick="zoomIn()" title="Zoom in">+</button>
          <button onclick="zoomReset()" title="Reset zoom" style="font-size:0.8rem">‚ü≤</button>
        </div>
      </div>
      <div class="page-preview-title" id="previewTitle"></div>
      <button class="page-preview-close" onclick="closePagePreview()" title="Close">&times;</button>
    </div>
    <div class="page-preview-image-container">
      <img class="page-preview-image" id="previewImage" src="" alt="Page preview" />
    </div>
    <div class="page-preview-footer">
      <label>Download:</label>
      <select class="page-range-select" id="pageRangeSelect">
        <option value="0">This page only</option>
        <option value="1">¬± 1 page (3 pages)</option>
        <option value="2">¬± 2 pages (5 pages)</option>
        <option value="5">¬± 5 pages (11 pages)</option>
        <option value="custom">Custom range...</option>
      </select>
      <button class="page-preview-download" onclick="downloadPreviewPages()">
        ‚¨á Download PDF
      </button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-overlay" id="settingsModal">
    <div class="settings-modal">
      <div class="settings-header">
        <h2>‚öôÔ∏è Settings</h2>
        <button class="settings-close" onclick="closeSettings()">√ó</button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h3>üìÑ PDF/Documents</h3>
          <div class="settings-field">
            <label>Root Directory</label>
            <div class="path-input-row">
              <input type="text" id="settingPdfRoot" placeholder="/path/to/pdfs" />
              <button onclick="browseDirectory('pdf_root', 'settingPdfRoot')">Browse</button>
              <button class="index-btn" onclick="indexNow('pdf')" title="Index PDFs now">üîÑ Index</button>
            </div>
            <div class="index-status" id="pdfIndexStatus"></div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>üé≤ 3D Models</h3>
          <div class="settings-field">
            <label>Root Directory</label>
            <div class="path-input-row">
              <input type="text" id="setting3dRoot" placeholder="/path/to/3d-files" />
              <button onclick="browseDirectory('3d_root', 'setting3dRoot')">Browse</button>
              <button class="index-btn" onclick="indexNow('3d')" title="Index 3D files now">üîÑ Index</button>
            </div>
            <div class="index-status" id="3dIndexStatus"></div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>üñºÔ∏è 3D Model Maintenance</h3>
          <div class="settings-field">
            <label>Thumbnail Generation</label>
            <p style="font-size: 0.9rem; color: #888; margin-bottom: 12px;">Render missing or low-quality thumbnails for faster browsing</p>
            <div class="path-input-row">
              <button class="index-btn" onclick="renderAllThumbnails()" title="Render thumbnails for all 3D models" id="renderThumbBtn">üé¨ Render Thumbnails</button>
              <button class="index-btn" onclick="renderThumbStats()" title="Check thumbnail status">üìä Check Status</button>
            </div>
            <div class="index-status" id="renderThumbStatus"></div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>üåê Network Paths (SMB)</h3>
          <div class="settings-field">
            <label>Additional mount points (one per line)</label>
            <textarea id="settingSmbPaths" rows="3" placeholder="/Volumes/NAS/Media&#10;/Volumes/Share"></textarea>
            <button class="index-btn smb-index" onclick="indexNow('smb')" title="Index SMB paths now">üîÑ Index SMB Paths</button>
            <div class="index-status" id="smbIndexStatus"></div>
          </div>
        </div>
      </div>
      <div class="settings-footer">
        <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="upload-overlay" id="uploadModal">
    <div class="upload-modal">
      <div class="upload-header">
        <h2><span id="uploadIcon">üìÑ</span> Upload <span id="uploadTypeLabel">PDFs</span></h2>
        <button class="upload-close" onclick="closeUpload()">√ó</button>
      </div>
      <div class="upload-body">
        <div class="upload-section">
          <h3>üìÅ Select Destination Folder</h3>
          <div class="upload-path-display">
            <span class="path" id="uploadCurrentPath">Loading...</span>
          </div>
          <div class="upload-folder-list" id="uploadFolderList"></div>
          <div class="upload-new-folder">
            <input type="text" id="newFolderName" placeholder="New folder name..." />
            <button onclick="createUploadFolder()">üìÅ Create</button>
          </div>
        </div>
        
        <div class="upload-section">
          <h3>üìé Select Files</h3>
          <div class="upload-dropzone" id="uploadDropzone" onclick="document.getElementById('uploadFileInput').click()">
            <div class="upload-dropzone-icon">üìÅ</div>
            <div class="upload-dropzone-text">Drop files here or click to browse</div>
            <div class="upload-dropzone-hint" id="uploadHint">Accepted: .pdf</div>
          </div>
          <input type="file" id="uploadFileInput" multiple style="display:none" onchange="handleFileSelect(event)" />
          <div class="upload-file-list" id="uploadFileList"></div>
          <div class="upload-progress" id="uploadProgress">
            <div class="upload-progress-bar">
              <div class="upload-progress-fill" id="uploadProgressFill"></div>
            </div>
            <div class="upload-progress-text" id="uploadProgressText">Uploading...</div>
          </div>
        </div>
      </div>
      <div class="upload-footer">
        <div class="file-count" id="uploadFileCount">No files selected</div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="closeUpload()">Cancel</button>
          <button class="btn btn-primary" id="uploadSubmitBtn" onclick="submitUpload()" disabled>‚¨ÜÔ∏è Upload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Directory Browser Modal -->
  <div class="browser-overlay" id="browserModal">
    <div class="browser-modal">
      <div class="browser-header">
        <h3>üìÅ Select Directory</h3>
        <button class="browser-close" onclick="closeBrowser()">√ó</button>
      </div>
      <div class="browser-path" id="browserPath">/Volumes</div>
      <div class="browser-list" id="browserList"></div>
      <div class="browser-footer">
        <button class="btn btn-secondary" onclick="closeBrowser()">Cancel</button>
        <button class="btn btn-primary" onclick="selectBrowserPath()">‚úì Select</button>
      </div>
    </div>
  </div>

  <script>
    let currentView = 'grid';
    let currentFolder = null;
    let currentPublisher = null;
    let currentSort = 'filename';
    let currentOrder = 'asc';
    let contentType = 'pdf';  // 'pdf' or '3d'
    let currentCollection = null;
    let currentFormat = null;  // STL, OBJ, 3MF filter for 3D models
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadFolders();
      loadPublishers();
      loadAssets();
      // Pre-load 3D nav for quick switching
      load3dCollections();
      load3dFolders();
      
      // Search
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => search(e.target.value), 300);
      });
      
      // View toggle
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          toggleView();
        });
      });
      
      // Close modal on overlay click
      document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') closeModal();
      });
      
      // Delegated click handler for folder navigation links in modals
      document.getElementById('modalBody').addEventListener('click', (e) => {
        const link = e.target.closest('.folder-nav-link');
        if (link) {
          e.preventDefault();
          const folder = link.dataset.folder;
          console.log('Folder link clicked:', folder);
          navigateToFolder(folder);
        }
      });
      
      // Close page preview on overlay click
      document.getElementById('pagePreview').addEventListener('click', (e) => {
        if (e.target.id === 'pagePreview') closePagePreview();
      });
    });
    
    async function loadStats() {
      if (contentType === 'pdf') {
        const res = await fetch('/api/stats');
        const stats = await res.json();
        document.getElementById('stats').textContent = 
          `${stats.total_assets} PDFs ¬∑ ${stats.total_size_gb} GB`;
      } else {
        const res = await fetch('/api/models/stats');
        const stats = await res.json();
        document.getElementById('stats').textContent = 
          `${stats.total_models} Models ¬∑ ${stats.total_size_mb} MB`;
      }
    }
    
    function setContentType(type) {
      contentType = type;
      
      // Update toggle buttons
      document.getElementById('togglePdf').classList.toggle('active', type === 'pdf');
      document.getElementById('toggle3d').classList.toggle('active', type === '3d');
      
      // Update search placeholder
      document.getElementById('searchInput').placeholder = 
        type === 'pdf' ? 'Search PDFs...' : 'Search 3D models...';
      
      // Toggle nav sections
      document.getElementById('pdfNav').style.display = type === 'pdf' ? 'block' : 'none';
      document.getElementById('modelsNav').style.display = type === '3d' ? 'block' : 'none';
      
      // Show/hide format filter (only for 3D models)
      document.getElementById('formatFilter').style.display = type === '3d' ? 'inline-block' : 'none';
      
      // Clear current filters
      currentFolder = null;
      currentPublisher = null;
      currentCollection = null;
      currentFormat = null;
      document.getElementById('searchInput').value = '';
      document.getElementById('formatFilter').value = '';
      document.getElementById('contentResults').style.display = 'none';
      
      // Reload content
      loadStats();
      if (type === 'pdf') {
        loadFolders();
        loadAssets();
      } else {
        load3dFolders();
        load3dCollections();
        load3dModels();
      }
    }
    
    // 3D Model folder tree data
    let modelFolderTreeData = [];
    let expandedModelFolders = new Set();
    
    async function load3dCollections() {
      const res = await fetch('/api/models/collections');
      const collections = await res.json();
      
      const list = document.getElementById('collectionList');
      list.innerHTML = collections.map(c => `
        <li onclick="filter3dCollection('${escapeHtml(c.collection)}')" 
            class="${currentCollection === c.collection ? 'active' : ''}">
          ${escapeHtml(c.collection)}
          <span class="count-badge">${c.count}</span>
        </li>
      `).join('');
    }
    
    async function load3dFolders() {
      const res = await fetch('/api/models/folder-tree');
      const data = await res.json();
      const flat = data.flat || [];
      
      // Sort by path (natural tree order for renderLevel traversal)
      // This ensures parent-child hierarchy is preserved
      modelFolderTreeData = flat.sort((a, b) => a.path.localeCompare(b.path));
      
      render3dFolderTree();
    }
    
    function render3dFolderTree() {
      const container = document.getElementById('modelFolderTree');
      const totalCount = modelFolderTreeData.filter(f => f.depth === 0).reduce((a, f) => a + f.count, 0);
      
      // Build hierarchical HTML (same structure as PDF folder tree)
      let html = `
        <div class="tree-item ${!currentFolder ? 'active' : ''}" onclick="filter3dFolder(null)">
          <span class="toggle"></span>
          <span class="folder-name">üé≤ All Models</span>
          <span class="count-badge">${totalCount}</span>
        </div>
      `;
      
      const renderLevel = (items, parentDepth = -1) => {
        let result = '';
        let i = 0;
        while (i < items.length) {
          const item = items[i];
          if (item.depth <= parentDepth) break;
          if (item.depth === parentDepth + 1) {
            const hasChildren = item.hasChildren;
            const isExpanded = expandedModelFolders.has(item.path);
            const isActive = currentFolder === item.path;
            const indent = item.depth * 16;
            
            let childrenHtml = '';
            if (hasChildren && isExpanded) {
              // Only render children when expanded (lazy loading for performance)
              const childItems = [];
              let j = i + 1;
              while (j < items.length && items[j].depth > item.depth) {
                childItems.push(items[j]);
                j++;
              }
              childrenHtml = renderLevel(childItems, item.depth);
            }
            
            const jsPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            result += `
              <div style="padding-left: ${indent}px;">
                <div class="tree-item ${isActive ? 'active' : ''}" 
                     data-path="${escapeHtml(item.path)}"
                     onclick="handle3dTreeClick(event, '${jsPath}', ${hasChildren})">
                  <span class="toggle">${hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : ''}</span>
                  <span class="folder-name">${escapeHtml(item.name)}</span>
                  <span class="count-badge">${item.count}</span>
                </div>
                ${(hasChildren && isExpanded) ? `<div class="tree-children expanded" data-parent="${escapeHtml(item.path)}">${childrenHtml}</div>` : ''}
              </div>
            `;
          }
          i++;
        }
        return result;
      };
      
      html += renderLevel(modelFolderTreeData);
      container.innerHTML = html;
    }
    
    function handle3dTreeClick(event, path, hasChildren) {
      event.stopPropagation();
      const rect = event.currentTarget.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      
      if (hasChildren && clickX < 30) {
        if (expandedModelFolders.has(path)) {
          expandedModelFolders.delete(path);
        } else {
          expandedModelFolders.add(path);
        }
        render3dFolderTree();
      } else {
        filter3dFolder(path);
      }
    }
    
    function filter3dFolder(folder) {
      currentFolder = folder;
      currentCollection = null;  // Clear collection filter when filtering by folder
      
      // Auto-expand all parent folders to show path to current folder
      if (folder) {
        const parts = folder.split('/');
        for (let i = 1; i <= parts.length; i++) {
          const parentPath = parts.slice(0, i).join('/');
          expandedModelFolders.add(parentPath);
        }
      }
      
      load3dCollections();  // Update active states
      render3dFolderTree();
      load3dModels();
    }
    
    async function load3dModels() {
      let url = '/api/models?limit=100';
      if (currentCollection) {
        url += `&collection=${encodeURIComponent(currentCollection)}`;
      }
      if (currentFolder) {
        url += `&folder=${encodeURIComponent(currentFolder)}`;
      }
      if (currentFormat) {
        url += `&format=${encodeURIComponent(currentFormat)}`;
      }
      
      const res = await fetch(url);
      const models = await res.json();
      render3dModels(models);
    }
    
    function changeFormatFilter() {
      currentFormat = document.getElementById('formatFilter').value || null;
      load3dModels();
    }
    
    function filter3dCollection(collection) {
      currentCollection = collection;
      currentFolder = null;  // Clear folder filter when filtering by collection
      load3dCollections();
      render3dFolderTree();
      load3dModels();
    }
    
    function render3dModels(models) {
      const grid = document.getElementById('assetGrid');
      const list = document.getElementById('assetList');
      
      if (models.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <h3>No 3D models found</h3>
            <p>Index your 3D files from Settings</p>
          </div>
        `;
        list.innerHTML = '';
        return;
      }
      
      // Grid view with preview thumbnails (cache-bust every 10s for pending renders)
      const cacheBust = Math.floor(Date.now() / 10000);
      grid.innerHTML = models.map(m => `
        <div class="asset-card" onclick="show3dDetail(${m.id})" title="ID: ${m.id}">
          <img class="asset-thumb model-grid-thumb" src="/api/models/${m.id}/preview?t=${cacheBust}" alt="" loading="lazy" 
               onerror="console.error('Thumb failed for model ${m.id}:', this.src); this.src='/static/placeholder-3d.svg';" />
          <div class="asset-info">
            <div class="asset-title" title="${escapeHtml(m.filename)}">${escapeHtml(m.title || m.filename)}</div>
            <div class="asset-meta">${(m.format || 'stl').toUpperCase()} ¬∑ ${formatSize(m.file_size)} ¬∑ #${m.id}</div>
          </div>
        </div>
      `).join('');
      
      // List view
      list.innerHTML = models.map(m => `
        <div class="asset-row" onclick="show3dDetail(${m.id})">
          <img src="/api/models/${m.id}/preview?t=${cacheBust}" alt="" loading="lazy" 
               onerror="this.outerHTML='<div class=\\'model-icon-small\\'>üé≤</div>'" />
          <div>
            <div class="title">${escapeHtml(m.title || m.filename)}</div>
            <div class="publisher">${escapeHtml(m.collection || '')}</div>
          </div>
          <div class="publisher">${(m.format || 'stl').toUpperCase()}</div>
          <div class="pages">${m.has_supports ? '‚úì Supported' : ''}</div>
          <div class="size">${formatSize(m.file_size)}</div>
        </div>
      `).join('');
    }
    
    // Current model for 3D viewer
    let current3dModelId = null;
    let threeViewer = null;
    
    async function show3dDetail(id) {
      current3dModelId = id;
      const res = await fetch(`/api/models/${id}`);
      const model = await res.json();
      
      // Use same structure as PDF modal for consistency
      document.getElementById('modalBody').innerHTML = `
        <div class="model-preview-area">
          <img class="model-thumb-img" src="/api/models/${id}/preview" alt="" 
               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <div class="model-thumb-fallback" style="display:none;">üé≤</div>
          <div id="viewer3d" class="viewer-3d"></div>
          <div class="viewer-controls" id="viewerControls">
            <button onclick="resetViewer()" title="Reset view">‚ü≤</button>
            <button onclick="toggleWireframe()" title="Toggle wireframe">‚óá</button>
            <button onclick="close3dViewer()" title="Close 3D view">‚úï</button>
          </div>
        </div>
        <div class="modal-details">
          <h2>${escapeHtml(model.title || model.filename)}</h2>
          
          <div class="detail-row">
            <span class="detail-label">Filename</span>
            <span class="detail-value">${escapeHtml(model.filename)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Format</span>
            <span class="detail-value">${(model.format || 'stl').toUpperCase()}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Collection</span>
            <span class="detail-value">${escapeHtml(model.collection || '‚Äî')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">File Size</span>
            <span class="detail-value">${formatSize(model.file_size)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Supports</span>
            <span class="detail-value">${model.has_supports ? '‚úì Pre-supported' : 'No'}</span>
          </div>
          ${model.folder_path ? `
          <div class="detail-row">
            <span class="detail-label">Location</span>
            <span class="detail-value breadcrumbs">üìÅ ${renderBreadcrumbs(model.folder_path)}</span>
          </div>
          ` : ''}
          ${model.archive_path ? `
          <div class="detail-row">
            <span class="detail-label">Archive</span>
            <span class="detail-value" style="font-size:0.8rem">üì¶ ${escapeHtml(model.archive_path.split('/').pop())}</span>
          </div>
          ` : ''}
          
          <div class="modal-actions">
            <button class="btn btn-secondary" onclick="open3dViewer(${id})" id="btn3dPreview">
              üéÆ 3D Preview
            </button>
            <a href="/api/models/${id}/download" class="btn btn-primary">
              ‚¨á Download
            </a>
          </div>
        </div>
      `;
      
      document.getElementById('modal').classList.add('active');
    }
    
    // Three.js viewer state
    let threeJsLoaded = false;
    
    // Three.js viewer functions
    let loadedLoaders = { stl: false, obj: false, '3mf': false };
    
    async function open3dViewer(modelId) {
      const btn = document.getElementById('btn3dPreview');
      if (btn) btn.textContent = '‚è≥ Loading...';
      
      try {
        // Get model info to determine format
        const res = await fetch(`/api/models/${modelId}`);
        const model = await res.json();
        const format = (model.format || 'stl').toLowerCase();
        
        // Check if Three.js is loaded
        if (!threeJsLoaded) {
          // Load Three.js, controls, and fflate (needed for 3MF) from CDN
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js');
          await loadScript('https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js');
          await loadScript('https://cdn.jsdelivr.net/npm/fflate@0.8.0/umd/index.js');
          threeJsLoaded = true;
        }
        
        // Load format-specific loader
        if (format === 'stl' && !loadedLoaders.stl) {
          await loadScript('https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js');
          loadedLoaders.stl = true;
        } else if (format === 'obj' && !loadedLoaders.obj) {
          await loadScript('https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/OBJLoader.js');
          loadedLoaders.obj = true;
        } else if (format === '3mf' && !loadedLoaders['3mf']) {
          // fflate already loaded with Three.js base
          await loadScript('https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/3MFLoader.js');
          loadedLoaders['3mf'] = true;
        }
        
        // Hide static preview, show 3D viewer
        const previewImg = document.querySelector('.model-preview-area .model-thumb-img');
        const fallback = document.querySelector('.model-preview-area .model-thumb-fallback');
        const viewerDiv = document.getElementById('viewer3d');
        const controls = document.getElementById('viewerControls');
        
        if (previewImg) previewImg.style.display = 'none';
        if (fallback) fallback.style.display = 'none';
        if (viewerDiv) viewerDiv.style.display = 'block';
        if (controls) controls.style.display = 'flex';
        
        if (btn) btn.style.display = 'none';
        
        // Initialize Three.js scene with format info
        if (viewerDiv) init3dViewer(viewerDiv, modelId, format);
      } catch (e) {
        console.error('Failed to load Three.js:', e);
        if (btn) btn.textContent = '‚ùå Load failed';
      }
    }
    
    function close3dViewer() {
      const previewImg = document.querySelector('.model-preview-area .model-thumb-img');
      const fallback = document.querySelector('.model-preview-area .model-thumb-fallback');
      const viewerDiv = document.getElementById('viewer3d');
      const controls = document.getElementById('viewerControls');
      const btn = document.getElementById('btn3dPreview');
      
      if (viewerDiv) {
        viewerDiv.style.display = 'none';
        viewerDiv.innerHTML = '';
      }
      if (controls) controls.style.display = 'none';
      
      if (previewImg) previewImg.style.display = 'block';
      else if (fallback) fallback.style.display = 'flex';
      
      if (btn) {
        btn.style.display = 'inline-block';
        btn.textContent = 'üéÆ 3D Preview';
      }
      
      threeViewer = null;
    }
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        // Check if already loaded
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    function init3dViewer(container, modelId, format = 'stl') {
      // Clear any previous viewer
      container.innerHTML = '';
      
      const width = container.clientWidth || 200;
      const height = container.clientHeight || 200;
      
      // Check Three.js loaded properly
      if (typeof THREE === 'undefined') {
        console.error('THREE not loaded');
        container.innerHTML = '<div style="color:red;padding:20px;">Three.js failed to load</div>';
        return;
      }
      
      // Check format-specific loader
      const loaderCheck = {
        'stl': () => typeof THREE.STLLoader !== 'undefined',
        'obj': () => typeof THREE.OBJLoader !== 'undefined',
        '3mf': () => typeof THREE.ThreeMFLoader !== 'undefined'
      };
      
      if (!loaderCheck[format] || !loaderCheck[format]()) {
        console.error(`${format.toUpperCase()} Loader not loaded`);
        container.innerHTML = `<div style="color:red;padding:20px;">${format.toUpperCase()} Loader failed to load</div>`;
        return;
      }
      
      // Scene
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);
      
      // Camera
      const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
      camera.position.set(0, 50, 100);
      
      // Renderer
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);
      
      // Controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      
      // Lights
      const ambientLight = new THREE.AmbientLight(0x404040, 2);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
      directionalLight.position.set(50, 100, 50);
      scene.add(directionalLight);
      
      const backLight = new THREE.DirectionalLight(0xffffff, 0.5);
      backLight.position.set(-50, 50, -50);
      scene.add(backLight);
      
      // Grid
      const gridHelper = new THREE.GridHelper(100, 10, 0x4dabf7, 0x333366);
      scene.add(gridHelper);
      
      // Show loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#4dabf7;';
      loadingDiv.textContent = '‚è≥ Loading...';
      container.appendChild(loadingDiv);
      
      // Create format-specific loader
      let loader;
      if (format === 'stl') {
        loader = new THREE.STLLoader();
      } else if (format === 'obj') {
        loader = new THREE.OBJLoader();
      } else if (format === '3mf') {
        loader = new THREE.ThreeMFLoader();
      }
      
      // Material for the model
      const material = new THREE.MeshPhongMaterial({ 
        color: 0x4dabf7,
        specular: 0x111111,
        shininess: 30,
        flatShading: false
      });
      
      // Load model file
      loader.load(
        `/api/models/${modelId}/file`,
        (result) => {
          loadingDiv.remove();
          
          let mesh;
          
          if (format === 'stl') {
            // STLLoader returns geometry
            mesh = new THREE.Mesh(result, material);
          } else if (format === 'obj' || format === '3mf') {
            // OBJLoader and 3MFLoader return Object3D/Group
            mesh = result;
            // Apply material to all meshes in the group
            mesh.traverse((child) => {
              if (child.isMesh) {
                child.material = material;
              }
            });
          }
          
          // Compute bounding box for any format
          const bbox = new THREE.Box3().setFromObject(mesh);
          const center = new THREE.Vector3();
          bbox.getCenter(center);
          mesh.position.sub(center);
          
          // Auto-scale to fit view
          const size = new THREE.Vector3();
          bbox.getSize(size);
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 50 / maxDim;
          mesh.scale.set(scale, scale, scale);
          
          // Position on grid
          const newBbox = new THREE.Box3().setFromObject(mesh);
          mesh.position.y = -newBbox.min.y;
          
          scene.add(mesh);
          
          // Store for controls
          threeViewer = { scene, camera, renderer, controls, mesh, material };
          
          // Fit camera
          camera.position.set(maxDim * scale, maxDim * scale, maxDim * scale * 1.5);
          controls.target.set(0, 25, 0);
          controls.update();
      },
      // Progress callback
      (xhr) => {
        if (xhr.lengthComputable) {
          const pct = Math.round(xhr.loaded / xhr.total * 100);
          loadingDiv.textContent = `‚è≥ Loading ${pct}%`;
        }
      },
      // Error callback
      (error) => {
        console.error(`3D model load error (${format}):`, error);
        loadingDiv.textContent = `‚ùå Failed to load ${format.toUpperCase()} model`;
        loadingDiv.style.color = '#ff6b6b';
      }
      );
      
      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      
      // Handle resize
      const resizeObserver = new ResizeObserver(() => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });
      resizeObserver.observe(container);
    }
    
    function resetViewer() {
      if (threeViewer) {
        const { camera, controls, mesh } = threeViewer;
        camera.position.set(50, 50, 75);
        controls.target.set(0, 25, 0);
        controls.update();
      }
    }
    
    function toggleWireframe() {
      if (threeViewer && threeViewer.material) {
        threeViewer.material.wireframe = !threeViewer.material.wireframe;
      }
    }
    
    let expandedFolders = new Set();
    let folderTreeData = [];
    
    async function loadFolders() {
      const res = await fetch('/api/folder-tree');
      const data = await res.json();
      const flat = data.flat || [];
      
      // Sort by path (natural tree order for renderLevel traversal)
      // This ensures parent-child hierarchy is preserved in depth-first order
      folderTreeData = flat.sort((a, b) => a.path.localeCompare(b.path));
      
      renderFolderTree();
    }
    
    function renderFolderTree() {
      const container = document.getElementById('folderTree');
      const totalCount = folderTreeData.filter(f => f.depth === 0).reduce((a, f) => a + f.count, 0);
      
      // Build hierarchical HTML
      let html = `
        <div class="tree-item ${!currentFolder ? 'active' : ''}" onclick="filterFolder(null)">
          <span class="toggle"></span>
          <span class="folder-name">üìö All Files</span>
          <span class="count-badge">${totalCount}</span>
        </div>
      `;
      
      // Group items by parent path for tree rendering
      const renderLevel = (items, parentDepth = -1) => {
        let result = '';
        let i = 0;
        while (i < items.length) {
          const item = items[i];
          if (item.depth <= parentDepth) break;
          if (item.depth === parentDepth + 1) {
            const hasChildren = item.hasChildren;
            const isExpanded = expandedFolders.has(item.path);
            const isActive = currentFolder === item.path;
            const indent = item.depth * 16;
            
            // Find children
            let childrenHtml = '';
            if (hasChildren && isExpanded) {
              // Only render children when expanded (lazy loading for performance)
              const childItems = [];
              let j = i + 1;
              while (j < items.length && items[j].depth > item.depth) {
                childItems.push(items[j]);
                j++;
              }
              childrenHtml = renderLevel(childItems, item.depth);
            }
            
            const jsPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            result += `
              <div style="padding-left: ${indent}px;">
                <div class="tree-item ${isActive ? 'active' : ''}" 
                     data-path="${escapeHtml(item.path)}"
                     onclick="handleTreeClick(event, '${jsPath}', ${hasChildren})">
                  <span class="toggle">${hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : ''}</span>
                  <span class="folder-name">${escapeHtml(item.name)}</span>
                  <span class="count-badge">${item.count}</span>
                </div>
                ${(hasChildren && isExpanded) ? `<div class="tree-children expanded" data-parent="${escapeHtml(item.path)}">${childrenHtml}</div>` : ''}
              </div>
            `;
          }
          i++;
        }
        return result;
      };
      
      html += renderLevel(folderTreeData);
      container.innerHTML = html;
    }
    
    function handleTreeClick(event, path, hasChildren) {
      event.stopPropagation();
      
      // If clicking toggle area or has children, toggle expand
      const rect = event.currentTarget.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      
      if (hasChildren && clickX < 30) {
        // Toggle expansion
        if (expandedFolders.has(path)) {
          expandedFolders.delete(path);
        } else {
          expandedFolders.add(path);
        }
        renderFolderTree();
      } else {
        // Filter by this folder
        filterFolder(path);
      }
    }
    
    async function loadPublishers() {
      const res = await fetch('/api/publishers');
      const publishers = await res.json();
      const list = document.getElementById('publisherList');
      
      list.innerHTML = publishers.slice(0, 15).map(p => `
        <li class="${currentPublisher === p.publisher ? 'active' : ''}"
            onclick="filterPublisher('${p.publisher}')">
          ${p.publisher || 'Unknown'}
          <span class="count-badge">${p.count}</span>
        </li>
      `).join('');
    }
    
    async function loadAssets() {
      let url = `/api/assets?limit=100&sort=${currentSort}&order=${currentOrder}`;
      if (currentFolder) url += `&folder=${encodeURIComponent(currentFolder)}`;
      if (currentPublisher) url += `&publisher=${encodeURIComponent(currentPublisher)}`;
      
      const res = await fetch(url);
      const assets = await res.json();
      renderAssets(assets);
      toggleView();
    }
    
    function changeSort() {
      const val = document.getElementById('sortSelect').value;
      const [sort, order] = val.split(':');
      currentSort = sort;
      currentOrder = order;
      
      if (lastSearchQuery) {
        search(lastSearchQuery);
      } else if (contentType === '3d') {
        load3dModels();
      } else {
        loadAssets();
      }
    }
    
    function clearFilters() {
      currentFolder = null;
      currentPublisher = null;
      currentCollection = null;
      currentFormat = null;
      currentSort = 'filename';
      currentOrder = 'asc';
      document.getElementById('searchInput').value = '';
      document.getElementById('sortSelect').value = 'filename:asc';
      document.getElementById('formatFilter').value = '';
      document.getElementById('contentResults').style.display = 'none';
      lastSearchQuery = '';
      
      // Load content based on current view type
      if (contentType === '3d') {
        load3dFolders();
        load3dCollections();
        load3dModels();
      } else {
        loadFolders();
        loadPublishers();
        loadAssets();
      }
    }
    
    function goHome() {
      clearFilters();
      clearAdvancedSearch();
    }
    
    let searchTermCount = 1;
    
    function toggleAdvancedSearch() {
      const panel = document.getElementById('advancedSearchPanel');
      const btn = document.querySelector('.adv-search-toggle');
      panel.classList.toggle('open');
      btn.classList.toggle('active');
      
      // Update scope option when opening
      if (panel.classList.contains('open')) {
        updateScopeOption();
      }
    }
    
    function updateScopeOption() {
      const scopeOption = document.getElementById('advScopeCurrent');
      if (currentFolder) {
        const folderName = currentFolder.split('/').pop();
        scopeOption.textContent = `Current: ${folderName}`;
        scopeOption.disabled = false;
      } else {
        scopeOption.textContent = 'Current folder (select a folder first)';
        scopeOption.disabled = true;
        document.getElementById('advSearchScope').value = 'all';
      }
    }
    
    function addSearchTerm() {
      const container = document.getElementById('advSearchTerms');
      const rowNum = searchTermCount++;
      
      const row = document.createElement('div');
      row.className = 'adv-term-row';
      row.dataset.row = rowNum;
      row.innerHTML = `
        <select class="term-operator">
          <option value="AND">AND</option>
          <option value="OR">OR</option>
        </select>
        <span class="term-label">in</span>
        <select class="term-field">
          <option value="all">Title & Content</option>
          <option value="title">Title only</option>
          <option value="content">Content only</option>
        </select>
        <select class="term-include">
          <option value="include">contains</option>
          <option value="exclude">does NOT contain</option>
        </select>
        <input type="text" class="term-input" placeholder="Enter search term..." />
        <button class="term-remove" onclick="removeSearchTerm(${rowNum})">‚úï</button>
      `;
      container.appendChild(row);
    }
    
    function removeSearchTerm(rowNum) {
      const row = document.querySelector(`.adv-term-row[data-row="${rowNum}"]`);
      if (row) row.remove();
    }
    
    function clearAdvancedSearch() {
      document.getElementById('advSearchScope').value = 'all';
      
      // Reset to single search term
      const container = document.getElementById('advSearchTerms');
      container.innerHTML = `
        <div class="adv-term-row" data-row="0">
          <span class="term-label">Find in</span>
          <select class="term-field">
            <option value="all">Title & Content</option>
            <option value="title">Title only</option>
            <option value="content">Content only</option>
          </select>
          <select class="term-include">
            <option value="include">contains</option>
            <option value="exclude">does NOT contain</option>
          </select>
          <input type="text" class="term-input" placeholder="Enter search term..." />
        </div>
      `;
      searchTermCount = 1;
    }
    
    function buildAdvancedQuery() {
      const rows = document.querySelectorAll('.adv-term-row');
      const terms = [];
      
      rows.forEach((row, i) => {
        const input = row.querySelector('.term-input');
        const include = row.querySelector('.term-include');
        const operator = row.querySelector('.term-operator');
        const field = row.querySelector('.term-field');
        
        const term = input.value.trim();
        if (!term) return;
        
        const isExclude = include.value === 'exclude';
        const op = operator ? operator.value : 'AND';
        const searchField = field ? field.value : 'all';
        
        terms.push({
          term: term,
          exclude: isExclude,
          operator: op,
          field: searchField
        });
      });
      
      return terms;
    }
    
    async function runAdvancedSearch() {
      const terms = buildAdvancedQuery();
      if (terms.length === 0) return;
      
      const scope = document.getElementById('advSearchScope').value;
      const folder = (scope === 'current' && currentFolder) ? currentFolder : null;
      
      // Build search request
      const searchParams = new URLSearchParams();
      searchParams.set('terms', JSON.stringify(terms));
      if (folder) searchParams.set('folder', folder);
      
      const res = await fetch(`/api/search/advanced?${searchParams}`);
      const results = await res.json();
      
      // Update search input to show query summary
      const queryDisplay = terms.map(t => {
        let s = '';
        if (t.operator && terms.indexOf(t) > 0) s += t.operator + ' ';
        if (t.exclude) s += 'NOT ';
        s += `"${t.term}"`;
        if (t.field !== 'all') s += ` (${t.field})`;
        return s;
      }).join(' ');
      document.getElementById('searchInput').value = queryDisplay;
      lastSearchQuery = queryDisplay;
      
      // Render results (API uses 'assets'/'pages', fallback to 'metadata'/'content')
      renderAssets(results.assets || results.metadata || []);
      renderContentResults(results.pages || results.content || [], queryDisplay);
      toggleView();
    }
    
    function getAdvancedFilters() {
      return {
        scope: document.getElementById('advSearchScope')?.value || 'all',
        field: 'all',  // Title + Content by default
        publisher: null,
        gameSystem: null
      };
    }
    
    let lastSearchQuery = '';
    
    async function search(query) {
      if (!query) {
        lastSearchQuery = '';
        searchMatchesByAsset = {};
        document.getElementById('contentResults').style.display = 'none';
        
        // Load appropriate content type
        if (contentType === '3d') {
          load3dModels();
        } else {
          loadAssets();
        }
        return;
      }
      
      lastSearchQuery = query;
      
      // Different search for 3D models vs PDFs
      if (contentType === '3d') {
        const res = await fetch(`/api/models/search?q=${encodeURIComponent(query)}`);
        const models = await res.json();
        document.getElementById('contentResults').style.display = 'none';
        render3dModels(models);
        toggleView();
        return;
      }
      
      // PDF search with advanced filters
      const adv = getAdvancedFilters();
      let searchUrl = `/api/search/all?q=${encodeURIComponent(query)}`;
      
      // Scope search to current folder if selected
      if (adv.scope === 'current' && currentFolder) {
        searchUrl += `&folder=${encodeURIComponent(currentFolder)}`;
      }
      if (adv.field !== 'all') {
        searchUrl += `&field=${adv.field}`;
      }
      if (adv.publisher) {
        searchUrl += `&publisher=${encodeURIComponent(adv.publisher)}`;
      }
      if (adv.gameSystem) {
        searchUrl += `&system=${encodeURIComponent(adv.gameSystem)}`;
      }
      
      const res = await fetch(searchUrl);
      const results = await res.json();
      
      // API returns 'assets' and 'pages', map to expected keys
      const assets = results.assets || results.metadata || [];
      const pages = results.pages || results.content || [];
      
      // Sort metadata results client-side
      let sortedMetadata = sortResults(assets);
      
      // Render metadata matches (or show message if empty)
      if (sortedMetadata.length === 0 && pages.length > 0) {
        // Only content matches, no title/filename matches
        document.getElementById('assetGrid').innerHTML = '';
        document.getElementById('assetList').innerHTML = '';
      } else {
        renderAssets(sortedMetadata);
      }
      
      // Render content matches with page numbers (sorted)
      renderContentResults(pages, query);
      
      // Ensure view toggle is applied
      toggleView();
    }
    
    function sortResults(assets) {
      if (!assets || assets.length === 0) return assets;
      
      const sorted = [...assets];
      sorted.sort((a, b) => {
        let valA = a[currentSort];
        let valB = b[currentSort];
        
        // Handle nulls
        if (valA == null) valA = '';
        if (valB == null) valB = '';
        
        // String comparison for text fields
        if (typeof valA === 'string') {
          valA = valA.toLowerCase();
          valB = (valB || '').toLowerCase();
        }
        
        let result = 0;
        if (valA < valB) result = -1;
        if (valA > valB) result = 1;
        
        return currentOrder === 'desc' ? -result : result;
      });
      
      return sorted;
    }
    
    function renderContentResults(results, query) {
      const container = document.getElementById('contentResults');
      
      if (!results || results.length === 0) {
        container.style.display = 'none';
        searchMatchesByAsset = {};  // Clear search matches
        return;
      }
      
      // Group by asset
      const byAsset = {};
      results.forEach(r => {
        if (!byAsset[r.asset_id]) {
          byAsset[r.asset_id] = {
            asset_id: r.asset_id,
            title: r.title,
            filename: r.filename,
            folder_path: r.folder_path,
            publisher: r.publisher,
            pages: []
          };
        }
        byAsset[r.asset_id].pages.push({
          page_num: r.page_num,
          snippet: r.snippet
        });
      });
      
      // Store matches for detail modal access
      searchMatchesByAsset = {};
      Object.values(byAsset).forEach(a => {
        searchMatchesByAsset[a.asset_id] = a.pages;
      });
      
      // Sort the grouped assets
      let assets = Object.values(byAsset);
      assets.sort((a, b) => {
        let valA = a[currentSort] || a.filename;
        let valB = b[currentSort] || b.filename;
        if (typeof valA === 'string') {
          valA = valA.toLowerCase();
          valB = (valB || '').toLowerCase();
        }
        let result = valA < valB ? -1 : (valA > valB ? 1 : 0);
        return currentOrder === 'desc' ? -result : result;
      });
      
      // Grid view for content results
      const gridHtml = assets.map(a => `
        <div class="asset-card" onclick="showDetail(${a.asset_id})">
          <img class="asset-thumb" src="/api/thumbnail/${a.asset_id}" alt="" loading="lazy" />
          <div class="asset-info">
            <div class="asset-title" title="${escapeHtml(a.title || a.filename)}">${escapeHtml(a.title || a.filename)}</div>
            <div class="asset-meta">${a.pages.length} page matches</div>
          </div>
        </div>
      `).join('');
      
      // List view for content results
      const listHtml = assets.map(a => `
        <div class="content-result-card">
          <div class="content-result-header">
            <img src="/api/thumbnail/${a.asset_id}" alt="" onclick="showDetail(${a.asset_id})" />
            <div>
              <div class="title" onclick="showDetail(${a.asset_id})" style="cursor:pointer">${escapeHtml(a.title || a.filename)}</div>
              <div class="path breadcrumbs">${renderBreadcrumbs(a.folder_path)}</div>
            </div>
          </div>
          <div class="page-matches">
            ${a.pages.slice(0, 5).map(p => `
              <div class="page-match" onclick="openToPage(${a.asset_id}, ${p.page_num})">
                <span class="page-num">p.${p.page_num}</span>
                <span class="snippet">${p.snippet}</span>
              </div>
            `).join('')}
            ${a.pages.length > 5 ? `<div class="more-pages">+${a.pages.length - 5} more pages</div>` : ''}
          </div>
        </div>
      `).join('');
      
      container.innerHTML = `
        <h3>üìÑ Content Matches (${results.length} pages in ${assets.length} PDFs)</h3>
        <div class="content-grid ${currentView === 'grid' ? '' : 'hidden'}">${gridHtml}</div>
        <div class="content-list ${currentView === 'list' ? '' : 'hidden'}">${listHtml}</div>
      `;
      container.style.display = 'block';
    }
    
    function renderAssets(assets) {
      const grid = document.getElementById('assetGrid');
      const list = document.getElementById('assetList');
      
      if (assets.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <h3>No PDFs found</h3>
            <p>Run the indexer to scan your PDF collection</p>
          </div>
        `;
        list.innerHTML = '';
        return;
      }
      
      // Grid view
      grid.innerHTML = assets.map(a => `
        <div class="asset-card" onclick="showDetail(${a.id})">
          <img class="asset-thumb" src="/api/thumbnail/${a.id}" alt="" loading="lazy" />
          <div class="asset-info">
            <div class="asset-title" title="${escapeHtml(a.title || a.filename)}">${escapeHtml(a.title || a.filename)}</div>
            <div class="asset-meta">${a.page_count || '?'} pages</div>
          </div>
        </div>
      `).join('');
      
      // List view
      list.innerHTML = assets.map(a => `
        <div class="asset-row" onclick="showDetail(${a.id})">
          <img src="/api/thumbnail/${a.id}" alt="" loading="lazy" />
          <div>
            <div class="title">${escapeHtml(a.title || a.filename)}</div>
            <div class="publisher">${escapeHtml(a.publisher || '')}</div>
          </div>
          <div class="publisher">${escapeHtml(a.game_system || '')}</div>
          <div class="pages">${a.page_count || '?'} pages</div>
          <div class="size">${formatSize(a.file_size)}</div>
        </div>
      `).join('');
    }
    
    function filterFolder(folder) {
      // Clear search state
      lastSearchQuery = '';
      searchMatchesByAsset = {};
      document.getElementById('searchInput').value = '';
      document.getElementById('contentResults').style.display = 'none';
      
      currentFolder = folder;
      currentPublisher = null;
      currentCollection = null;
      
      // Auto-expand all parent folders to show path to current folder
      if (folder) {
        const parts = folder.split('/');
        for (let i = 1; i <= parts.length; i++) {
          const parentPath = parts.slice(0, i).join('/');
          expandedFolders.add(parentPath);
        }
      }
      
      loadFolders();
      loadPublishers();
      
      // Load assets based on current mode
      if (contentType === '3d') {
        load3dModels();
      } else {
        loadAssets();
      }
      updateScopeOption();
    }
    
    function filterPublisher(publisher) {
      // Clear search state
      lastSearchQuery = '';
      searchMatchesByAsset = {};
      document.getElementById('searchInput').value = '';
      document.getElementById('contentResults').style.display = 'none';
      
      currentPublisher = publisher;
      loadPublishers();
      loadAssets();
    }
    
    // Store search matches by asset ID for display in detail modal
    let searchMatchesByAsset = {};
    
    async function showDetail(id) {
      bookmarksLoaded = false;  // Reset for new asset
      const res = await fetch(`/api/assets/${id}`);
      const asset = await res.json();
      
      // Check if we have search matches for this asset
      const matches = searchMatchesByAsset[id] || [];
      let searchMatchesHtml = '';
      
      if (matches.length > 0) {
        searchMatchesHtml = `
          <div class="search-matches-section">
            <h4>üîç Search Matches (${matches.length} pages)</h4>
            <div class="search-matches-list">
              ${matches.map(m => `
                <div class="page-match" onclick="closeModal(); openToPage(${id}, ${m.page_num})">
                  <span class="page-num">p.${m.page_num}</span>
                  <span class="snippet">${m.snippet}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      document.getElementById('modalBody').innerHTML = `
        <div>
          <img class="modal-thumb" src="/api/thumbnail/${id}" alt="" />
        </div>
        <div class="modal-details">
          <h2>${escapeHtml(asset.title || asset.filename)}</h2>
          
          <div class="detail-row">
            <span class="detail-label">Filename</span>
            <span class="detail-value">${escapeHtml(asset.filename)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Author</span>
            <span class="detail-value">${escapeHtml(asset.author || '‚Äî')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Publisher</span>
            <span class="detail-value">${escapeHtml(asset.publisher || '‚Äî')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Game System</span>
            <span class="detail-value">${escapeHtml(asset.game_system || '‚Äî')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Pages</span>
            <span class="detail-value">${asset.page_count || '‚Äî'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">File Size</span>
            <span class="detail-value">${formatSize(asset.file_size)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Path</span>
            <span class="detail-value breadcrumbs">${renderBreadcrumbs(asset.folder_path)}</span>
          </div>
          
          ${searchMatchesHtml}
          
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="closeModal(); openToPage(${id}, 1)">
              üìñ Preview
            </button>
            <a href="/api/download/${id}" class="btn btn-secondary" download>
              ‚¨á Download
            </a>
          </div>
          
          <div class="page-extract-section">
            <h4>üìÑ Extract Pages</h4>
            <div class="page-extract-row">
              <input type="text" id="extractPages" placeholder="e.g., 1, 3, 5-10" class="page-input" />
              <button class="btn btn-secondary" onclick="extractPages(${id}, ${asset.page_count})">
                Extract & Download
              </button>
            </div>
            <div class="page-extract-hint">
              Enter page numbers (1-${asset.page_count || '?'}). Use commas for individual pages, dashes for ranges.
            </div>
          </div>
          
          <div class="bookmarks-section" id="bookmarksSection">
            <h4 onclick="toggleBookmarks(${id})" style="cursor:pointer">
              üìë Table of Contents <span id="bookmarksToggle">‚ñ∂</span>
            </h4>
            <div class="bookmarks-list" id="bookmarksList" style="display:none"></div>
          </div>
        </div>
      `;
      
      document.getElementById('modal').classList.add('active');
    }
    
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) modal.classList.remove('active');
    }
    
    // Page Preview Modal State
    let previewAssetId = null;
    let previewCurrentPage = 1;
    let previewTotalPages = 1;
    let previewAssetTitle = '';
    let previewZoom = 100;  // Zoom percentage
    
    function updateZoomUI() {
      document.getElementById('zoomLevel').textContent = previewZoom + '%';
      const img = document.getElementById('previewImage');
      img.style.transform = `scale(${previewZoom / 100})`;
      img.style.transformOrigin = 'center center';
    }
    
    function zoomIn() {
      if (previewZoom < 300) {
        previewZoom = Math.min(300, previewZoom + 25);
        updateZoomUI();
      }
    }
    
    function zoomOut() {
      if (previewZoom > 25) {
        previewZoom = Math.max(25, previewZoom - 25);
        updateZoomUI();
      }
    }
    
    function zoomReset() {
      previewZoom = 100;
      updateZoomUI();
    }
    
    async function openToPage(assetId, pageNum) {
      // Open page preview modal instead of full PDF
      previewAssetId = assetId;
      previewCurrentPage = pageNum;
      
      // Reset zoom
      previewZoom = 100;
      updateZoomUI();
      
      // Get asset info for total pages and title
      const res = await fetch(`/api/assets/${assetId}`);
      const asset = await res.json();
      previewTotalPages = asset.page_count || 1;
      previewAssetTitle = asset.title || asset.filename;
      
      // Update UI
      document.getElementById('previewTitle').textContent = previewAssetTitle;
      document.getElementById('previewPageNum').textContent = pageNum;
      document.getElementById('previewTotalPages').textContent = previewTotalPages;
      
      // Update nav buttons
      updatePreviewNavButtons();
      
      // Load the page image
      loadPreviewPage(assetId, pageNum);
      
      // Show modal
      document.getElementById('pagePreview').classList.add('active');
      
      // Handle escape key
      document.addEventListener('keydown', handlePreviewKeydown);
    }
    
    function loadPreviewPage(assetId, pageNum) {
      const img = document.getElementById('previewImage');
      img.classList.add('loading');
      img.src = `/api/render/${assetId}/${pageNum}?zoom=2`;
      img.onload = () => img.classList.remove('loading');
    }
    
    function updatePreviewNavButtons() {
      document.getElementById('prevPageBtn').disabled = previewCurrentPage <= 1;
      document.getElementById('nextPageBtn').disabled = previewCurrentPage >= previewTotalPages;
    }
    
    function previewPrevPage() {
      if (previewCurrentPage > 1) {
        previewCurrentPage--;
        document.getElementById('previewPageNum').textContent = previewCurrentPage;
        loadPreviewPage(previewAssetId, previewCurrentPage);
        updatePreviewNavButtons();
      }
    }
    
    function previewNextPage() {
      if (previewCurrentPage < previewTotalPages) {
        previewCurrentPage++;
        document.getElementById('previewPageNum').textContent = previewCurrentPage;
        loadPreviewPage(previewAssetId, previewCurrentPage);
        updatePreviewNavButtons();
      }
    }
    
    function handlePreviewKeydown(e) {
      if (!document.getElementById('pagePreview').classList.contains('active')) return;
      
      if (e.key === 'Escape') {
        closePagePreview();
      } else if (e.key === 'ArrowLeft') {
        previewPrevPage();
      } else if (e.key === 'ArrowRight') {
        previewNextPage();
      } else if (e.key === '+' || e.key === '=') {
        zoomIn();
      } else if (e.key === '-' || e.key === '_') {
        zoomOut();
      } else if (e.key === '0') {
        zoomReset();
      }
    }
    
    function closePagePreview() {
      document.getElementById('pagePreview').classList.remove('active');
      document.removeEventListener('keydown', handlePreviewKeydown);
    }
    
    function downloadPreviewPages() {
      const rangeSelect = document.getElementById('pageRangeSelect');
      const range = rangeSelect.value;
      
      if (range === 'custom') {
        const customRange = prompt(
          `Enter page range (1-${previewTotalPages}):\nExamples: "5-10" or "1,3,5-8"`,
          `${previewCurrentPage}`
        );
        if (customRange) {
          window.location.href = `/api/extract-pages/${previewAssetId}?pages=${encodeURIComponent(customRange)}`;
        }
        return;
      }
      
      const offset = parseInt(range);
      const startPage = Math.max(1, previewCurrentPage - offset);
      const endPage = Math.min(previewTotalPages, previewCurrentPage + offset);
      
      let pages;
      if (startPage === endPage) {
        pages = `${startPage}`;
      } else {
        pages = `${startPage}-${endPage}`;
      }
      
      window.location.href = `/api/extract-pages/${previewAssetId}?pages=${encodeURIComponent(pages)}`;
    }
    
    function extractPages(assetId, maxPages) {
      const pagesInput = document.getElementById('extractPages');
      const pages = pagesInput.value.trim();
      
      if (!pages) {
        alert('Please enter page numbers to extract');
        return;
      }
      
      // Validate format
      if (!/^[\d,\s-]+$/.test(pages)) {
        alert('Invalid format. Use numbers, commas, and dashes only.\nExample: 1, 3, 5-10');
        return;
      }
      
      // Download extracted pages
      window.location.href = `/api/extract-pages/${assetId}?pages=${encodeURIComponent(pages)}`;
    }
    
    let bookmarksLoaded = false;
    
    async function toggleBookmarks(assetId) {
      const list = document.getElementById('bookmarksList');
      const toggle = document.getElementById('bookmarksToggle');
      
      if (list.style.display === 'none') {
        list.style.display = 'block';
        toggle.textContent = '‚ñº';
        
        if (!bookmarksLoaded) {
          list.innerHTML = '<div class="bookmarks-empty">Loading...</div>';
          
          const res = await fetch(`/api/assets/${assetId}/bookmarks`);
          const bookmarks = await res.json();
          
          if (bookmarks.length === 0) {
            list.innerHTML = '<div class="bookmarks-empty">No table of contents available</div>';
          } else {
            list.innerHTML = bookmarks.map(b => `
              <div class="bookmark-item bookmark-level-${Math.min(b.level, 4)}" 
                   onclick="openToPage(${assetId}, ${b.page_num})">
                <span class="bookmark-title" title="${escapeHtml(b.title)}">${escapeHtml(b.title)}</span>
                <span class="bookmark-page">p.${b.page_num}</span>
              </div>
            `).join('');
          }
          bookmarksLoaded = true;
        }
      } else {
        list.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }
    
    function toggleView() {
      const grid = document.getElementById('assetGrid');
      const list = document.getElementById('assetList');
      const contentGrid = document.querySelector('.content-grid');
      const contentList = document.querySelector('.content-list');
      
      if (currentView === 'grid') {
        grid.classList.remove('hidden');
        list.classList.remove('active');
        if (contentGrid) contentGrid.classList.remove('hidden');
        if (contentList) contentList.classList.add('hidden');
      } else {
        grid.classList.add('hidden');
        list.classList.add('active');
        if (contentGrid) contentGrid.classList.add('hidden');
        if (contentList) contentList.classList.remove('hidden');
      }
    }
    
    function formatSize(bytes) {
      if (!bytes) return '‚Äî';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function renderBreadcrumbs(folderPath) {
      if (!folderPath) return '‚Äî';
      const parts = folderPath.split('/');
      const crumbs = parts.map((part, i) => {
        const fullPath = parts.slice(0, i + 1).join('/');
        // Use data attribute to avoid HTML escaping issues with & and quotes
        return `<a href="#" class="breadcrumb-link" data-folder="${escapeHtml(fullPath)}" onclick="event.preventDefault(); event.stopPropagation(); navigateToFolder(this.dataset.folder)">${escapeHtml(part)}</a>`;
      });
      return crumbs.join(' <span class="breadcrumb-sep">‚Ä∫</span> ');
    }
    
    function navigateToFolder(path) {
      console.log('navigateToFolder called with:', path, 'contentType:', contentType);
      closeModal();
      // Clear search so folder filter takes effect
      document.getElementById('searchInput').value = '';
      document.getElementById('contentResults').style.display = 'none';
      lastSearchQuery = '';
      
      // Use the right filter based on current mode
      if (contentType === '3d') {
        console.log('Calling filter3dFolder');
        filter3dFolder(path);
      } else {
        console.log('Calling filterFolder');
        filterFolder(path);
      }
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }
    
    // ==================== SETTINGS ====================
    
    let browserTargetSetting = null;
    let browserTargetInput = null;
    
    async function openSettings() {
      // Load current settings
      try {
        const res = await fetch('/api/settings');
        const settings = await res.json();
        
        document.getElementById('settingPdfRoot').value = settings.pdf_root || '';
        document.getElementById('setting3dRoot').value = settings['3d_root'] || '';
        document.getElementById('settingSmbPaths').value = 
          settings.smb_paths ? JSON.parse(settings.smb_paths).join('\n') : '';
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
      
      document.getElementById('settingsModal').classList.add('active');
    }
    
    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }
    
    async function saveSettings() {
      const smbPaths = document.getElementById('settingSmbPaths').value
        .split('\n')
        .map(p => p.trim())
        .filter(p => p);
      
      const settings = {
        pdf_root: document.getElementById('settingPdfRoot').value,
        '3d_root': document.getElementById('setting3dRoot').value,
        smb_paths: JSON.stringify(smbPaths)
      };
      
      try {
        const res = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (res.ok) {
          closeSettings();
          alert('Settings saved! You may need to re-index content for changes to take effect.');
        } else {
          alert('Failed to save settings');
        }
      } catch (e) {
        alert('Error saving settings: ' + e.message);
      }
    }
    
    async function browseDirectory(settingKey, inputId) {
      browserTargetSetting = settingKey;
      browserTargetInput = inputId;
      await loadBrowserDirectory('/Volumes');
      document.getElementById('browserModal').classList.add('active');
    }
    
    async function loadBrowserDirectory(path) {
      try {
        const res = await fetch(`/api/browse-directory?path=${encodeURIComponent(path)}`);
        const data = await res.json();
        
        document.getElementById('browserPath').textContent = data.current;
        
        let html = '';
        if (data.parent) {
          html += `<div class="browser-item parent" onclick="loadBrowserDirectory('${data.parent}')">
            üìÅ ..
          </div>`;
        }
        
        html += data.entries.map(e => `
          <div class="browser-item" onclick="loadBrowserDirectory('${e.path}')">
            üìÅ ${e.name}
          </div>
        `).join('');
        
        document.getElementById('browserList').innerHTML = html || '<div style="padding:20px;color:#888">No subdirectories</div>';
      } catch (e) {
        console.error('Failed to browse:', e);
      }
    }
    
    function closeBrowser() {
      document.getElementById('browserModal').classList.remove('active');
    }
    
    function selectBrowserPath() {
      const path = document.getElementById('browserPath').textContent;
      if (browserTargetInput) {
        document.getElementById(browserTargetInput).value = path;
      }
      closeBrowser();
    }
    
    async function indexNow(type) {
      const statusId = type + 'IndexStatus';
      const statusEl = document.getElementById(statusId);
      
      let path;
      if (type === 'pdf') {
        path = document.getElementById('settingPdfRoot').value;
      } else if (type === '3d') {
        path = document.getElementById('setting3dRoot').value;
      } else if (type === 'smb') {
        const paths = document.getElementById('settingSmbPaths').value
          .split('\n').map(p => p.trim()).filter(p => p);
        if (paths.length === 0) {
          statusEl.className = 'index-status error';
          statusEl.textContent = '‚ùå No SMB paths configured';
          return;
        }
        path = paths.join(',');
      }
      
      if (!path) {
        statusEl.className = 'index-status error';
        statusEl.textContent = '‚ùå No path configured';
        return;
      }
      
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Indexing started... This may take a while.';
      
      try {
        const res = await fetch('/api/index', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, path })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          statusEl.className = 'index-status success';
          statusEl.textContent = `‚úÖ ${data.message}`;
          // Refresh stats
          loadStats();
        } else {
          statusEl.className = 'index-status error';
          statusEl.textContent = `‚ùå ${data.error}`;
        }
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      }
    }
    
    // ==================== 3D THUMBNAIL RENDERING ====================
    
    async function renderAllThumbnails() {
      const statusEl = document.getElementById('renderThumbStatus');
      const btn = document.getElementById('renderThumbBtn');
      
      btn.disabled = true;
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Rendering thumbnails... This may take several minutes.';
      
      try {
        const res = await fetch('/api/models/render-thumbnails', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        
        if (res.ok) {
          statusEl.className = 'index-status success';
          statusEl.textContent = `‚úÖ ${data.message} (${data.models_queued} queued, ${data.already_cached} cached)`;
          loadStats();
        } else {
          statusEl.className = 'index-status error';
          statusEl.textContent = `‚ùå ${data.error}`;
        }
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      } finally {
        btn.disabled = false;
      }
    }
    
    async function renderThumbStats() {
      const statusEl = document.getElementById('renderThumbStatus');
      
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Checking thumbnail status...';
      
      try {
        const res = await fetch('/api/models/thumbnail-stats');
        const data = await res.json();
        
        if (res.ok) {
          const percent = Math.round((data.cached / data.total) * 100);
          statusEl.className = 'index-status info';
          statusEl.textContent = `üìä ${data.cached} / ${data.total} cached (${percent}%)`;
        } else {
          statusEl.className = 'index-status error';
          statusEl.textContent = `‚ùå ${data.error}`;
        }
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      }
    }
    
    // ==================== BACKUP FUNCTIONALITY ====================
    
    async function createBackup() {
      const statusEl = document.getElementById('backupStatus');
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Creating backup...';
      
      try {
        const res = await fetch('/api/backup', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          statusEl.className = 'index-status success';
          statusEl.textContent = `‚úÖ ${data.message} (${data.size_mb} MB)`;
        } else {
          statusEl.className = 'index-status error';
          statusEl.textContent = `‚ùå ${data.error}`;
        }
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      }
    }
    
    async function showBackups() {
      const listEl = document.getElementById('backupList');
      const statusEl = document.getElementById('backupStatus');
      
      if (listEl.style.display === 'block') {
        listEl.style.display = 'none';
        return;
      }
      
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Loading backups...';
      
      try {
        const res = await fetch('/api/backups');
        const data = await res.json();
        
        statusEl.className = '';
        statusEl.textContent = '';
        
        if (data.backups.length === 0) {
          listEl.innerHTML = '<div style="color:var(--text-secondary);padding:8px;">No backups found</div>';
        } else {
          listEl.innerHTML = `
            <div style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:8px;">
              Available backups (click to restore):
            </div>
            ${data.backups.map(b => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--bg-card); border-radius:6px; margin-bottom:4px; cursor:pointer;"
                   onclick="restoreBackup('${b.filename}')"
                   title="Click to restore this backup">
                <span>üì¶ ${b.filename}</span>
                <span style="color:var(--text-secondary); font-size:0.85rem;">${b.size_mb} MB</span>
              </div>
            `).join('')}
          `;
        }
        listEl.style.display = 'block';
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      }
    }
    
    async function restoreBackup(filename) {
      if (!confirm(`Restore database from ${filename}?\n\nThis will replace your current database. A backup of the current state will be created first.`)) {
        return;
      }
      
      const statusEl = document.getElementById('backupStatus');
      statusEl.className = 'index-status active';
      statusEl.textContent = '‚è≥ Restoring backup...';
      
      try {
        const res = await fetch('/api/backup/restore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });
        const data = await res.json();
        
        if (data.success) {
          statusEl.className = 'index-status success';
          statusEl.textContent = `‚úÖ ${data.message}`;
          // Refresh page after 2 seconds
          setTimeout(() => location.reload(), 2000);
        } else {
          statusEl.className = 'index-status error';
          statusEl.textContent = `‚ùå ${data.error}`;
        }
      } catch (e) {
        statusEl.className = 'index-status error';
        statusEl.textContent = `‚ùå Error: ${e.message}`;
      }
    }
    
    // ==================== UPLOAD FUNCTIONALITY ====================
    
    let uploadFiles = [];
    let uploadCurrentPath = '';
    let uploadContentType = 'pdf';
    
    function openUpload() {
      uploadContentType = contentType;  // Use current content type from main UI
      uploadFiles = [];
      
      // Update UI for content type
      const icon = document.getElementById('uploadIcon');
      const label = document.getElementById('uploadTypeLabel');
      const hint = document.getElementById('uploadHint');
      
      if (uploadContentType === '3d') {
        icon.textContent = 'üé≤';
        label.textContent = '3D Models';
        hint.textContent = 'Accepted: .stl, .obj, .3mf, .zip, .rar, .7z';
        document.getElementById('uploadFileInput').accept = '.stl,.obj,.3mf,.zip,.rar,.7z';
      } else {
        icon.textContent = 'üìÑ';
        label.textContent = 'PDFs';
        hint.textContent = 'Accepted: .pdf';
        document.getElementById('uploadFileInput').accept = '.pdf';
      }
      
      // Reset file list
      document.getElementById('uploadFileList').innerHTML = '';
      document.getElementById('uploadFileCount').textContent = 'No files selected';
      document.getElementById('uploadSubmitBtn').disabled = true;
      document.getElementById('uploadProgress').classList.remove('active');
      document.getElementById('newFolderName').value = '';
      
      // Load initial folder
      loadUploadFolders();
      
      document.getElementById('uploadModal').classList.add('active');
    }
    
    function closeUpload() {
      document.getElementById('uploadModal').classList.remove('active');
      uploadFiles = [];
    }
    
    async function loadUploadFolders(path = null) {
      try {
        let url = `/api/upload/browse?type=${uploadContentType}`;
        if (path) url += `&path=${encodeURIComponent(path)}`;
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }
        
        uploadCurrentPath = data.current;
        document.getElementById('uploadCurrentPath').textContent = data.current;
        
        let html = '';
        
        // Parent folder link (if not at root)
        if (data.parent) {
          html += `
            <div class="upload-folder-item parent" onclick="loadUploadFolders('${escapeHtml(data.parent)}')">
              üìÅ ..
            </div>
          `;
        }
        
        // Subfolders
        data.entries.forEach(entry => {
          html += `
            <div class="upload-folder-item" onclick="loadUploadFolders('${escapeHtml(entry.path)}')">
              üìÅ ${escapeHtml(entry.name)}
            </div>
          `;
        });
        
        if (!data.parent && data.entries.length === 0) {
          html = '<div style="padding:20px;color:var(--text-secondary);text-align:center">No subfolders</div>';
        }
        
        document.getElementById('uploadFolderList').innerHTML = html;
      } catch (e) {
        console.error('Failed to load folders:', e);
        document.getElementById('uploadFolderList').innerHTML = 
          '<div style="padding:20px;color:#e74c3c;text-align:center">Failed to load folders</div>';
      }
    }
    
    async function createUploadFolder() {
      const nameInput = document.getElementById('newFolderName');
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('Please enter a folder name');
        return;
      }
      
      try {
        const res = await fetch('/api/upload/mkdir', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            parent: uploadCurrentPath,
            name: name,
            type: uploadContentType
          })
        });
        
        const data = await res.json();
        
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }
        
        nameInput.value = '';
        // Navigate to the new folder
        loadUploadFolders(data.path);
      } catch (e) {
        alert('Failed to create folder: ' + e.message);
      }
    }
    
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      addUploadFiles(files);
    }
    
    function addUploadFiles(files) {
      // Filter by content type
      const allowedExts = uploadContentType === '3d' 
        ? ['.stl', '.obj', '.3mf', '.zip', '.rar', '.7z']
        : ['.pdf'];
      
      files.forEach(file => {
        const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
        if (allowedExts.includes(ext)) {
          // Check if already added
          if (!uploadFiles.some(f => f.name === file.name && f.size === file.size)) {
            uploadFiles.push(file);
          }
        }
      });
      
      renderUploadFiles();
    }
    
    function removeUploadFile(index) {
      uploadFiles.splice(index, 1);
      renderUploadFiles();
    }
    
    function renderUploadFiles() {
      const list = document.getElementById('uploadFileList');
      const count = document.getElementById('uploadFileCount');
      const btn = document.getElementById('uploadSubmitBtn');
      
      if (uploadFiles.length === 0) {
        list.innerHTML = '';
        count.textContent = 'No files selected';
        btn.disabled = true;
        return;
      }
      
      const totalSize = uploadFiles.reduce((sum, f) => sum + f.size, 0);
      count.textContent = `${uploadFiles.length} file(s) ¬∑ ${formatSize(totalSize)}`;
      btn.disabled = false;
      
      list.innerHTML = uploadFiles.map((file, i) => `
        <div class="upload-file-item">
          <span class="name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
          <span class="size">${formatSize(file.size)}</span>
          <button class="remove" onclick="removeUploadFile(${i})" title="Remove">‚úï</button>
        </div>
      `).join('');
    }
    
    async function submitUpload() {
      if (uploadFiles.length === 0) return;
      
      const btn = document.getElementById('uploadSubmitBtn');
      const progress = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('uploadProgressFill');
      const progressText = document.getElementById('uploadProgressText');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Uploading...';
      progress.classList.add('active');
      progressFill.style.width = '0%';
      progressText.textContent = 'Starting upload...';
      
      const formData = new FormData();
      formData.append('destination', uploadCurrentPath);
      formData.append('type', uploadContentType);
      uploadFiles.forEach(file => formData.append('files', file));
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = pct + '%';
            progressText.textContent = `Uploading... ${pct}%`;
          }
        });
        
        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            progressFill.style.width = '100%';
            progressText.textContent = data.message;
            
            // Show success for 2 seconds, then close and refresh
            setTimeout(() => {
              closeUpload();
              // Clear any filters that might have been set
              currentFolder = null;
              currentPublisher = null;
              currentCollection = null;
              // Refresh everything properly
              if (uploadContentType === '3d') {
                load3dFolders();
                load3dCollections();
                load3dModels();
              } else {
                loadFolders();
                loadPublishers();
                loadAssets();
              }
              loadStats();
            }, 2000);
          } else {
            const data = JSON.parse(xhr.responseText);
            progressText.textContent = 'Error: ' + (data.error || 'Upload failed');
            progressFill.style.background = '#e74c3c';
            btn.disabled = false;
            btn.textContent = '‚¨ÜÔ∏è Upload';
          }
        });
        
        xhr.addEventListener('error', () => {
          progressText.textContent = 'Error: Upload failed';
          progressFill.style.background = '#e74c3c';
          btn.disabled = false;
          btn.textContent = '‚¨ÜÔ∏è Upload';
        });
        
        xhr.open('POST', '/api/upload');
        xhr.send(formData);
      } catch (e) {
        progressText.textContent = 'Error: ' + e.message;
        btn.disabled = false;
        btn.textContent = '‚¨ÜÔ∏è Upload';
      }
    }
    
    async function triggerReindex(path) {
      // Optionally trigger indexing for the uploaded folder
      try {
        await fetch('/api/index', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: uploadContentType,
            path: path
          })
        });
        console.log('Reindex triggered for:', path);
      } catch (e) {
        console.log('Reindex request failed (may not be implemented):', e);
      }
    }
    
    // Drag and drop support for upload dropzone
    (function() {
      const dropzone = document.getElementById('uploadDropzone');
      if (!dropzone) return;
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
        dropzone.addEventListener(event, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });
      
      ['dragenter', 'dragover'].forEach(event => {
        dropzone.addEventListener(event, () => {
          dropzone.classList.add('dragover');
        });
      });
      
      ['dragleave', 'drop'].forEach(event => {
        dropzone.addEventListener(event, () => {
          dropzone.classList.remove('dragover');
        });
      });
      
      dropzone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files);
        addUploadFiles(files);
      });
    })();
    
    // ==================== END UPLOAD ====================

    // Resize handle functionality
    (function() {
      const handle = document.getElementById('resizeHandle');
      const sidebar = document.getElementById('sidebar');
      let isDragging = false;
      
      handle.addEventListener('mousedown', (e) => {
        isDragging = true;
        handle.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const newWidth = e.clientX;
        if (newWidth >= 150 && newWidth <= window.innerWidth * 0.7) {
          sidebar.style.width = newWidth + 'px';
        }
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          handle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();
  </script>


</body>
</html>
